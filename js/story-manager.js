// 故事管理器 - 清理版本
class StoryManager {
    constructor() {
        this.stories = {};
        this.currentChapter = 1;
        this.currentParagraph = 0;
        this.isAutoPlaying = false;
        this.autoPlayInterval = null;
        this.textSpeed = 'normal';

        this.loadStories();
        this.initEventListeners();
    }

    loadStories() {
        // 第一章：日常
        this.stories[1] = [
            "咕噜，咕噜咕噜。",
            "吵闹，老师讲着解答，询问熟悉的同学代答。",
            "楼上传来进入教室的回声音，咯噔，咯噔，蹦咯，慢慢的从走廊门传来踏步声。",
            "慢慢的睁眼，睁开一半疲劳的眼睛，继续趴在桌子上等待。",
            "懒散的趴着，从到教室睡到中午吃饭后，到教室再次睡到放学，虽然中途必定会醒，但是还是要尝试继续睡到放学时间左右。",
            "睡不着?也是有的但是趴着和睡觉一样，放松思维，逐渐思考缓慢，虽然醒着但是比起呆着时间也过的快了。",
            "还是不行，也可以闭眼思考，我比较懒散记忆容易忘记，思考到和记忆相关的内容可能会想起来那一部分，或者思考我那零散的事情和幻想或者回忆记忆和回响的记忆中的梦境。",
            "任何事情都是懒散的，虽然想要完美但是没有沉浸，无法达成，如我想要绘画，想要音乐，想要小说，想要编程，任何一个都是巨大的内容。",
            "我的绘画停留在头部的外形模仿轮廓，音乐停留在如同随机生成一样，还是使用辅助工具，只有一种声音无比单调，只是我听起来能够播放不是噪声而已。",
            "小说只有开头那几字，我无法我的幻想转换成比较好的文字，从小学开始，就大概写过一篇作文吧，",
            "也可能只有半篇，到现在都没有写过，文字的阅历稀少，基本上每个人都会写的字我只知道读音，除了网上打字，虽然也容易不知道怎么拼，起码还能模糊的和记忆对上。",
            "我至于编程?没有希望，只依靠手机，只有那相关的概念和部分知识，和学习了一点就能随手修改能力",
            "我梦境相关的记忆有几个特别的断片在记忆里，也不知道是小时候的梦境还是什么，我意识清醒的梦境断片只有2个?吧。",
            "还有2个比较特的，小时候一次半夜睡觉醒来时，看到屋里炕上对面的玻璃有着灰色?的雾，和几个在雾里滚动?飘动?的像圆形的雾。",
            "大概我转头看向电视出现了幻想?",
            "但是不与电视重叠是偏移的，有点好几个一样大小的，透明模糊的图像和不同微小不规则的偏移图像在一起显示出电视的画面?",
            "我不知道，时间过去久远，画面无法想起，这些无法忘记，也无法分清是否是梦境。",
            "但是另一个，我无比清楚是在现实。",
            "在上幼儿园时的某天，我的视野里我在一直抖动，全身都在抖一样，坐在教室的小木板凳上，一直抖动，我记忆里，似乎如同观看一样，没有我控制身体的感觉，也没有其他的记忆，只有这件事的记忆。",
            "……",
            "直起一点点腰，不再趴着，双手放在桌子上懒散呆着，用带着模糊和大脑晕乎乎乏累的眼睛转头看向窗外。",
            "静静等待，放学时间的到来。",
            "xxx的学生站队了，听到声音伸向只有几个物品的桌兜，一瓶水装在书包的左边，拿出纸装在书包内，拉上书包，用两只手把用过的纸攒成一团，塞进书包右边。",
            "背上书包，把翻转的书包带翻正，排到左边的队伍走下楼梯，跟队伍走，直到大门分开，一人行走在路径，找到一起接送的车，坐到一直坐的位置，书包放在胸前继续趴着闭眼半睡。"
        ];

        // 第二章：家家
        this.stories[2] = [
            "咯噔，汽车跨过一条路上的小沟。",
            "抬起头靠在座椅背，看着车窗外流动的大地与田，实际只是看着发呆，等待送完别人。",
            "停车，开车。停车，开车。",
            "打开车门，抓着书包提带下车。",
            "走到门口，推一下大门的小门，没有动，用钥匙打开，进门，关上，在门内再次用钥匙锁上。",
            "打开屋门，关上。进到房间，把书包放在右炕头，上炕脱掉校服，躺在我最近一直睡觉的棉被上。",
            "……",
            "闭眼休息，直到现在，学校的作业从小学?开始到现在，一直几乎没有写过几次。",
            "上初中后就每天睡觉了，也没有去和同学聊天什么的，在家也基本只在家中游玩手机，在家周围也没朋友，也不会出去玩。",
            "近乎开始到现在，一直在家，不然就是学校。",
            "说起上学，也有点奇怪。。。吗，我一直都是不说话，新学期开始的几天会有点麻烦，过后就和以前一样了，也没有任何恶意的来找我，甚至和一个就是那样的人在一桌，也不会发生什么，只会是和普通的同学一样。",
            "唔……，懒散的躺着，随意的思考着记忆里回荡的片段记忆。",
            "直到现在，最近3个的记忆片段好像有点不一样。",
            "最新的一个片段是一个少女?萝莉?的女性，跑到一个遗迹?洞窟?，手举一个卡牌，举高着喊着魔法具显当然后面好像还有，但是想不起来了，去打一个什么东西。",
            "后一个片段，有点修仙者那种感觉?，有三个画面开始的是，一位少年在一木屋内，后木屋门口来了两位老人，一个貌相普通，拿着耙子，一个全身黑袍遮着全身，手持两个拐杖?。",
            "貌相普通的老人，貌似不死老人?，不知道只有这个感觉，告诉我它就是叫不死老人，黑袍的老人就不知道了。",
            "之后不死老人用耙子，把屋内少年直接勾出，后，不死老人的耙子把变的无比柔软一样可伸长，和具有红色的感觉?，打向少年，之后黑袍老人说了一句话，和我打都不用真身打他就用真身了?。",
            "大概这个就到这里了，后面想不起来了。",
            "另一个，就只是一段话一样了。",
            "从炕上醒来，和我家一样的，下炕，走到屋内的柜子处，蹲下，拉开最底下的抽屉。",
            "就只有这些例外的感觉就是，我一样，只不过女生的感觉?不太清楚。",
            "我梦境记忆，也让我有点幻想，比如如同信仰，我幻想着虚无，一切成为尘土，所有的一切转变成尘土一样，包含着一切的虚无。",
            "也让我不断了解内容，了解了如小说一样的内容。",
            "我，希望不会忘记，虽然它的外形，模样，名称，我都没有想像，但是它就坐在我那对面的椅子上，它那里的桌子上摆着我送的紫色的笔。",
            "信仰虽然只是我的幻想，但是也只是我一位而已，多了也可能就和别的一样了，虽然有所信仰，但是还是会告诉我是幻想。",
            "虽然只是我的幻想，但是也只是我一位而已，多了也可能就和别的一样了，虽然有所信仰，但是还是会告诉我是幻想。",
            "这也让我有点兴趣，了解那些相关的，我只了解了占卜的东西，虽然曾经就看过，时间比较早没有决定下来，我了解的只有塔罗牌与灵媒。",
            "塔罗牌，咕……只能说没有什么天赋，没有特殊的感觉，只凭借直觉选择了，只是我的塔罗牌也不会让我失望吗……。",
            "灵媒，根据我部分的了解，与自己的潜意识是有部分关联的，蛮快的，按照方法净化，只是手持，默念就已经开始动了。",
            "按照系统化样式的步骤，小的灵媒有点我摆不动，大的还好，幅度比较大一点点，询问是否同意添加限制，一会就开始在是的方向摆动了，按照文案，添加限制，灵摆也在我说的时候顺时针转动。",
            "就是不太懂顺时针旋转的意义，应该……没太大问题?。"
        ];

        // 第三章：修改
        this.stories[3] = [
            "我从躺着坐起来，转身掀开枕头左边查看。",
            "（嗯，刀片还在这里），放下枕头边，拍拍整齐一下，躺着侧身拿起手机，打开，打开阅读软件。",
            "唉又没有更新的。",
            "手指滑动，屏幕上划过那些永远会有一种，无数的相同内容的文本。",
            "又没有爱好的题材。",
            "真烦人。",
            "关闭手机，懒散的躺着看着天花板。",
            "明天又礼拜六了，就剩几天了。",
            "闭眼，开始睡觉。",
            "……",
            "黑暗，漆黑。",
            "四周空荡，飘浮的感觉，意识模糊无法看清。",
            "晃荡，周围逐渐开始闪烁，发亮，勾勒出无数的模样。",
            "构建出，被黑暗包围，和轻微笼罩的一片空间，和星空的图案包裹着里面。",
            "……",
            "眼睛乏累，缓慢睁开，四肢发力放松。",
            "嗯？头部转动，周围全是星空的样子。",
            "梦？",
            "嗯？不对我终于做清醒梦了？",
            "伸出手，熟悉的形状。",
            "不对啊，我记得清醒梦不继续想梦境，是会直接清醒的啊，怎么我没有在想还在梦里？",
            "旋转手臂，查看手心，伸出另一只手捏捏。",
            "算了不管了反正应该是梦里，到时候就醒了，上次还被梦里的一个声音说该醒过来了，然后我妈就叫我了。",
            "低下头，查看下半身。",
            "emm身体在梦境什么的应该都是能改的，和创造任何幻想东西一样的吧。",
            "创建一个镜子吧，emm相反，镜像，照射，画面。",
            "镜子是这种感觉吧？",
            "在近乎在和脚底一样的高度，开始缓慢的，向上凝聚成了一面近1米63的镜子。",
            "咕emm，先是去除身下和其他汗毛，还有一点点胡子，咕好久没有这种清爽的感觉了哭。",
            "摸着大腿说着。",
            "转头对着镜子看着脸。",
            "emm脸怎么搞呢，我想不出来脸啊，咕搞搞看。",
            "在镜中，一个模糊看起来散发着雾气样子，像头的形状的雾气，突然开始了变形，变成了一个，既怎么看也不有一点对称，和不规则的脸形，颜色也都不是任何正常的颜色。",
            "咕！咕！不行不行不搞了呜，太难了根本想不出来。",
            "镜中的雾气再次变换只看过几次的模糊面貌，虽然还是雾气，但是有一点形状的雾了。",
            "转头看向双臂。",
            "嗯缩短一点点，咕再短几厘米，咕！好了。",
            "看相下面。",
            "emm腿部，缩小再缩小，缩小形状，修改，再添加，身体调整，小肚子缩小一点点，修改几处颜色，再放大一厘米，再删减下面，添加外形。",
            "好力，耶。",
            "看着全身一米35，萝莉体型的身体，头部是个没有头一样的雾气emmmm。",
            "噗，啊啊啊我不会改脸啊。",
            "嗯...，我记得在我头发长到差几厘米到肩膀，去学校的时候，同班同学说过和姑娘一样，头发长起来，再用个黑袍吧，头遮起来吧，反正是梦看不看的到，我觉得看得到就看得到了。",
            "镜中黑色头发，快速生长到屁股的那里。",
            "咕颜色怎么改呢，这直接银色，直接成我看着和银打造成的头发一样，看着真壮观，但是这不好看啊。",
            "咕就这样吧稍微灰一点点，发尖稍微更灰色一点点，虽然还是看起来有点发亮(悲)。",
            "转动头部，散的白色头发甩动。",
            "嗯emm怎么扎头发呢，有了。",
            "在镜子中，白毛萝莉体型的人头发开始悬浮，起来分成3部分，在脸两边短的头发左边白丝带系上，和右边红色丝带，来不会让两边散开，在下面用过紫色发卡固定。",
            "后面的头发，emmm简单的直接扎成马尾。",
            "咕耶，真好看的头发。",
            "扭头看着，周围的星空。",
            "这……好像挺好的吧，唉，好累幻想好累啊啊啊啊。"
        ];

        // 第四章：创造
        this.stories[4] = [
            "看着镜子中，幼小的萝莉身体的头部和雾一样，像没头的萝莉嗯……。",
            "还是好丑啊。",
            "萝莉有点肉嘟嘟软软的双手贴着摸雾气摸出脸的感觉，一会一只手捏着。",
            "咕……创造东西……",
            "在胸前，逐渐凝聚出模糊的黑色细小丝线，慢慢的形成了一团黑色的雾气，缓慢飘动，像粘土一样，缓慢的变形。",
            "逐渐形成了像一件衣服的.....轮廓模样。",
            "额……啊啊啊，怎么怎么难。",
            "咕！对了我可以一边创造一边修改啊！",
            "胸前飘浮的模糊衣服，在空中开始变换，一个像衣服的帽子的区域，逐渐凝聚成实体，形成和黑色的布料相似的兜帽。",
            "耶！这样方便多了，就是额……我想象不太好。",
            "……",
            "过了不知道多长的一会时间，浮空的那件模糊的衣服，已经完全凝聚成了一件纯黑色外形的带着兜帽的黑袍衣服，只是从兜帽处看不见里面的样子，就是有点小。",
            "咕，终于完成创造衣服了，虽然是最简单的样子。",
            "悬浮的黑袍开始飘动，飞到在镜中我的后背，黑袍前面那没有任何纽扣和剪开的布料，如切割开的整齐分开，前面没有分割的布料，分开的黑袍两边张开，黑袍开始缓慢对齐身上的位置。",
            "宽大长长的黑袍逐渐缩短缩小，露出脚的部分拉长和在身上舒适的大小，分开的黑袍两边直接靠近在一起，缓慢的愈合如同没有切割过，兜帽缓慢的盖上，逐渐移动到能够遮住面部。",
            "耶！太帅啦，自动穿衣什么的。",
            "看着镜子中，穿着黑袍的矮小体型人，伸出肉嘟嘟的白皙小手向上举高。",
            "咕……嗯要不把里面的衣服换了？",
            "黑袍快速分裂，兜帽掀开，飞到一旁。",
            "看着镜子中，娇小的体型的萝莉，穿着宽大的秋衣，和在腰部看起来要脱落却悬浮起来没有掉下的秋裤。",
            "额……",
            "衣服闪动起来，逐渐模糊的如雾一样，露出光滑的肌肤，和肉肉的身体，分解的衣服发出亮光一样的光点，聚集成一团。",
            "唔……虽然我是创造者，就是在自己的作品在身上太不习惯了……",
            "嗯……这个光团？",
            "幻想光团移动到面前的轨迹，移动到面前，伸出手指戳戳。",
            "嗯？柔软的像……棉花？",
            "由于词汇量的稀少，只能回答出大概这个感觉的相近词。",
            "emmm，这棉花一样的光团有什么特别吗？，怎么还在这里？",
            "脑内幻想光团一部分伸出软软的布料，光团也伸出了出来，看起来对出来了一些幻想的内容，更加软，光滑，和舒适的感觉，想象别的布料，也就伸出更加好的布料，只是幻想着不是布料的物品就没有任何反应了。",
            "a？这好像就是emm像是含了所有的布料的布料？",
            "嘻嘻，那就用这个创造衣服吧，我想不了比较好的衣服，用这个大概会更加好一点，耶！",
            "……",
            "经过了，不知道多长时间的时间，但是肯定比前面长的时间后。",
            "耶！这件白色睡衣我之前就看着特别想要了，用这个光幻想那件睡衣的模样，外形，就自动做出来比那个布料的感觉更好的了。",
            "看着镜子中，穿着一件白色丝绸睡衣，里面白色内衬，外面用白色半透明丝绸组合的睡衣。",
            "咕，就是内衣柔软舒服和胸前不太习惯。",
            "双手按在胸前，透过衣服，感受身体软软的感觉。",
            "咕……不想了！",
            "呜……话说能不能把那种神奇的幻想出来呢？",
            "咕！试试！",
            "双手手心向上捧着，脑内幻想着那神秘的幻想。",
            "书，无尽的书页，无尽的空间，创造，修改，分析，收录，连接。",
            "咕姆，封皮样子就这里的一片星空吧，咕……添加一个我曾经用过的那个灵媒做书签吧。",
            "在手的上方，一个书的影子逐渐构成，封面逐渐漆黑，慢慢的开始一个一个亮点开始冒出，闪烁，逐渐构成一个旋涡一样向内吸收一样的星空图案。",
            "在书的上方，逐渐凝聚出一个白光的团，逐渐缩小，凝聚出了一个透明，但也非常明显能看出是带有紫色的锥形水晶。",
            "水晶逐渐出银色装饰，慢慢凝聚出银链连接到书上。",
            "耶！成功了！成功了！！",
            "双手抓住书，聚起来看。",
            "这个样子是真的好看耶！，嘻嘻这个水晶也和我想的修改的水晶一样，完美的那种透明又看得到颜色的感觉。",
            "松开书，悬浮起来，飘到眼睛看着舒适的角度，自动的翻开了书页。",
            "咕，测试看看，有没有我想的那种效果嘻嘻。"
        ];

        // 第五章：造物与意识
        this.stories[5] = [
            "身前，悬浮的书籍开始翻开，第一页发出亮光，掀开第一页空白的书页。",
            "唔……做什么好呢？",
            "空白的第一页书页上，逐渐出现了蓝色的能量？条状的雾？构成一个蓝色的悬浮球形。",
            "嗯……那种系统东西怎么做呢？",
            "透明球体的表面部分蓝色的能量?，开始扩张着球体形状，形成一个又一个不同大小不同长度的长方形?，正方形？",
            "构成了一个看起来，无比混乱的，用大小不一，形状不一的积木随意搭建的积木组成的球体？虽然表面不光滑，但像个球。",
            "嗯……怎么感觉怪怪的，算了",
            "唔...蓝色的面板，长方形的，再显示内容加一点点黑色透明背景",
            "那不规则长方形球体中，一个蓝色的像正方形的长方形有暗一点的感觉?，在面前空气中构建出了一个空白的面板?背景?。",
            "耶……好耶，显示内容基础有啦",
            "就是不知道做什么……啊"
        ];
    }

    initEventListeners() {
        // 文本控制按钮
        const prevBtn = Utils.$('.prev-btn');
        const nextBtn = Utils.$('.next-btn');
        const autoBtn = Utils.$('.auto-btn');

        if (prevBtn) prevBtn.addEventListener('click', () => this.previousParagraph());
        if (nextBtn) nextBtn.addEventListener('click', () => this.nextParagraph());
        if (autoBtn) autoBtn.addEventListener('click', () => this.toggleAutoPlay());

        // 键盘控制
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') this.previousParagraph();
            if (e.key === 'ArrowRight') this.nextParagraph();
            if (e.key === ' ') {
                e.preventDefault();
                this.toggleAutoPlay();
            }
        });
    }

    loadChapter(chapterNumber) {
        this.currentChapter = chapterNumber;
        this.currentParagraph = 0;
        this.stopAutoPlay();
        this.updateChapterInfo();
        this.displayCurrentText();
    }

    updateChapterInfo() {
        const chapterNames = {
            1: '日常',
            2: '家家',
            3: '修改',
            4: '创造',
            5: '造物与意识'
        };

        const currentChapterEl = Utils.$('#current-chapter');
        const chapterTitleEl = Utils.$('#chapter-title');

        if (currentChapterEl) currentChapterEl.textContent = `第${this.currentChapter}章`;
        if (chapterTitleEl) chapterTitleEl.textContent = chapterNames[this.currentChapter] || '';
    }

    displayCurrentText() {
        const story = this.stories[this.currentChapter];
        if (!story || !story[this.currentParagraph]) return;

        const textEl = Utils.$('#current-text');
        if (!textEl) return;

        const text = story[this.currentParagraph];

        // 打字机效果
        this.typewriterEffect(textEl, text);

        // 更新按钮状态
        this.updateButtonStates();
    }

    typewriterEffect(element, text) {
        element.textContent = '';

        const speeds = {
            slow: 100,
            normal: 50,
            fast: 20
        };

        const speed = speeds[this.textSpeed] || speeds.normal;
        let index = 0;

        const type = () => {
            if (index < text.length) {
                element.textContent += text.charAt(index);
                index++;
                setTimeout(type, speed);
            }
        };

        type();
    }

    updateButtonStates() {
        const prevBtn = Utils.$('.prev-btn');
        const nextBtn = Utils.$('.next-btn');
        const story = this.stories[this.currentChapter];

        if (prevBtn) {
            prevBtn.disabled = this.currentParagraph === 0;
        }

        if (nextBtn) {
            nextBtn.disabled = !story || this.currentParagraph >= story.length - 1;
        }
    }

    previousParagraph() {
        if (this.currentParagraph > 0) {
            this.currentParagraph--;
            this.displayCurrentText();
        }
    }

    nextParagraph() {
        const story = this.stories[this.currentChapter];
        if (story && this.currentParagraph < story.length - 1) {
            this.currentParagraph++;
            this.displayCurrentText();
        }
    }

    toggleAutoPlay() {
        if (this.isAutoPlaying) {
            this.stopAutoPlay();
        } else {
            this.startAutoPlay();
        }
    }

    startAutoPlay() {
        this.isAutoPlaying = true;
        const autoBtn = Utils.$('.auto-btn');
        if (autoBtn) {
            autoBtn.classList.add('active');
            autoBtn.textContent = '停止自动';
        }

        const speeds = {
            slow: 5000,
            normal: 3000,
            fast: 1500
        };

        const interval = speeds[this.textSpeed] || speeds.normal;

        this.autoPlayInterval = setInterval(() => {
            const story = this.stories[this.currentChapter];
            if (story && this.currentParagraph < story.length - 1) {
                this.nextParagraph();
            } else {
                this.stopAutoPlay();
            }
        }, interval);
    }

    stopAutoPlay() {
        this.isAutoPlaying = false;
        const autoBtn = Utils.$('.auto-btn');
        if (autoBtn) {
            autoBtn.classList.remove('active');
            autoBtn.textContent = '自动播放';
        }

        if (this.autoPlayInterval) {
            clearInterval(this.autoPlayInterval);
            this.autoPlayInterval = null;
        }
    }

    setTextSpeed(speed) {
        this.textSpeed = speed;
        if (this.isAutoPlaying) {
            this.stopAutoPlay();
            this.startAutoPlay();
        }
    }

    getCurrentProgress() {
        const story = this.stories[this.currentChapter];
        if (!story) return 0;
        return (this.currentParagraph + 1) / story.length;
    }

    isChapterComplete() {
        const story = this.stories[this.currentChapter];
        return story && this.currentParagraph >= story.length - 1;
    }

    getChapterCount() {
        return Object.keys(this.stories).length;
    }

    destroy() {
        this.stopAutoPlay();
    }
}

// 导出故事管理器
window.StoryManager = StoryManager;